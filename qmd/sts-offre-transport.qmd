---
title: "STS - Offre de transport: analyse descriptive"
format:
  html:
    toc: true
execute:
  echo: true
  warning: false
  message: false
---

## Contexte et objectifs

Ce document presente une analyse descriptive de l'offre de transport de la ST Sahel
(jeu de donnees GTFS). Les etapes suivent le plan demande: chargement des donnees,
statistiques globales, repartition par ligne, amplitude horaire, visualisations et
interpretation des resultats.

## Etape 1: Collecte et preparation des donnees

```{r}
library(dplyr)
library(ggplot2)
library(tidyr)

data_dir <- file.path("data", "STS")
if (!dir.exists(data_dir)) {
  data_dir <- file.path("qmd", "data", "STS")
}

read_gtfs <- function(path) {
  data <- read.delim(
    path,
    stringsAsFactors = FALSE,
    fileEncoding = "UTF-16LE",
    sep = "\t",
    header = FALSE,
    fill = TRUE,
    check.names = TRUE
  )
  data <- data[-1, , drop = FALSE]

  base <- basename(path)
  if (base == "routes.txt") {
    cols <- c(
      "agency_id",
      "route_short_name",
      "route_id",
      "route_long_name",
      "route_type",
      "route_type_name"
    )
  } else if (base == "stops.txt") {
    cols <- c("stop_id", "stop_name", "stop_lat", "stop_lon")
  } else if (base == "trips.txt") {
    cols <- c("trip_id", "route_id", "service_id", "direction_id", "shape_id")
  } else if (base == "stop-times.txt") {
    cols <- c(
      "trip_id",
      "stop_id",
      "arrival_time",
      "departure_time",
      "stop_sequence"
    )
  } else {
    cols <- paste0("v", seq_len(ncol(data)))
  }

  names(data) <- tolower(cols[seq_len(ncol(data))])
  data
}

routes <- read_gtfs(file.path(data_dir, "routes.txt"))
stops <- read_gtfs(file.path(data_dir, "stops.txt"))
trips <- read_gtfs(file.path(data_dir, "trips.txt"))
stop_times <- read_gtfs(file.path(data_dir, "stop-times.txt"))

routes$route_id <- as.character(routes$route_id)
trips$route_id <- as.character(trips$route_id)
trips$trip_id <- as.character(trips$trip_id)
stop_times$trip_id <- as.character(stop_times$trip_id)
stop_times$stop_id <- as.character(stop_times$stop_id)

parse_hhmmss_to_minutes <- function(x) {
  parts <- strsplit(x, ":", fixed = TRUE)
  sapply(parts, function(p) {
    if (length(p) < 3) {
      return(NA_real_)
    }
    as.numeric(p[1]) * 60 + as.numeric(p[2]) + as.numeric(p[3]) / 60
  })
}

minutes_to_hhmm <- function(m) {
  if (is.na(m)) {
    return(NA_character_)
  }
  m_round <- as.integer(round(m))
  h <- m_round %/% 60
  mins <- m_round %% 60
  sprintf("%02d:%02d", h, mins)
}

stop_times <- stop_times %>%
  mutate(
    dep_min = parse_hhmmss_to_minutes(departure_time),
    arr_min = parse_hhmmss_to_minutes(arrival_time)
  )

stop_times_clean <- stop_times %>%
  filter(!is.na(dep_min), !is.na(arr_min))
```

## Etape 2: Analyse descriptive et statistiques cles

```{r}
# Statistiques globales

total_lignes <- n_distinct(routes$route_id)
total_arrets <- n_distinct(stops$stop_id)
total_trajets <- nrow(trips)

first_bus_min <- min(stop_times_clean$dep_min, na.rm = TRUE)
last_bus_min <- max(stop_times_clean$arr_min, na.rm = TRUE)

first_bus_time <- minutes_to_hhmm(first_bus_min)
last_bus_time <- minutes_to_hhmm(last_bus_min)

amplitude_hours <- (last_bus_min - first_bus_min) / 60

# Repartition par ligne
trips_by_line <- trips %>%
  count(route_id, name = "Nombre_Trajets")

stops_by_line <- stop_times_clean %>%
  inner_join(trips %>% select(trip_id, route_id), by = "trip_id") %>%
  group_by(route_id) %>%
  summarise(Nombre_Arrets = n_distinct(stop_id), .groups = "drop")

line_stats <- full_join(trips_by_line, stops_by_line, by = "route_id") %>%
  left_join(
    routes %>% select(route_id, route_short_name, route_long_name),
    by = "route_id"
  ) %>%
  mutate(
    Nom_Ligne = ifelse(
      !is.na(route_short_name) & route_short_name != "",
      route_short_name,
      route_long_name
    )
  ) %>%
  select(route_id, Nom_Ligne, Nombre_Arrets, Nombre_Trajets) %>%
  mutate(
    Nombre_Arrets = replace_na(Nombre_Arrets, 0),
    Nombre_Trajets = replace_na(Nombre_Trajets, 0),
    Part_Trajets = Nombre_Trajets / sum(Nombre_Trajets)
  ) %>%
  arrange(desc(Nombre_Trajets))

arrets_stats <- line_stats %>%
  summarise(
    min_arrets = min(Nombre_Arrets, na.rm = TRUE),
    max_arrets = max(Nombre_Arrets, na.rm = TRUE),
    mean_arrets = mean(Nombre_Arrets, na.rm = TRUE),
    median_arrets = median(Nombre_Arrets, na.rm = TRUE),
    q1_arrets = quantile(Nombre_Arrets, 0.25, na.rm = TRUE),
    q3_arrets = quantile(Nombre_Arrets, 0.75, na.rm = TRUE)
  )

trajets_stats <- line_stats %>%
  summarise(
    min_trajets = min(Nombre_Trajets, na.rm = TRUE),
    max_trajets = max(Nombre_Trajets, na.rm = TRUE),
    mean_trajets = mean(Nombre_Trajets, na.rm = TRUE),
    median_trajets = median(Nombre_Trajets, na.rm = TRUE),
    q1_trajets = quantile(Nombre_Trajets, 0.25, na.rm = TRUE),
    q3_trajets = quantile(Nombre_Trajets, 0.75, na.rm = TRUE)
  )

percent <- function(x) paste0(round(x * 100, 1), "%")

top_15_share <- line_stats %>%
  mutate(part = Nombre_Trajets / sum(Nombre_Trajets, na.rm = TRUE)) %>%
  slice(1:15) %>%
  summarise(share = sum(part, na.rm = TRUE)) %>%
  pull(share)

top_10_lines <- line_stats %>%
  arrange(desc(Nombre_Trajets)) %>%
  slice_head(n = 10)
```

### Statistiques globales

- Nombre total de lignes: `r total_lignes`
- Nombre total d'arrets: `r total_arrets`
- Nombre total de trajets: `r total_trajets`
- Premier depart: `r first_bus_time`
- Derniere arrivee: `r last_bus_time`
- Amplitude horaire (heures): `r round(amplitude_hours, 2)`

### Repartition par ligne

```{r}
# Apercu des lignes les plus frequentes
line_stats %>%
  arrange(desc(Nombre_Trajets)) %>%
  head(10)
```

```{r}
# Tableau resume pour le top 10
top_10_lines %>%
  mutate(Part_Trajets = round(Part_Trajets * 100, 1)) %>%
  select(Nom_Ligne, Nombre_Arrets, Nombre_Trajets, Part_Trajets)
```

```{r}
# Statistiques des arrets par ligne
arrets_stats
```

```{r}
# Statistiques des trajets par ligne
trajets_stats
```

## Etape 3: Visualisations

### Distribution du nombre d'arrets par ligne

```{r}
ggplot(line_stats, aes(x = Nombre_Arrets)) +
  geom_histogram(binwidth = 2, fill = "#2b7a78", color = "white") +
  labs(
    title = "Distribution du nombre d'arrets par ligne",
    x = "Nombre d'arrets",
    y = "Nombre de lignes"
  ) +
  theme_minimal(base_size = 12)
```

### Distribution du nombre de trajets par ligne

```{r}
ggplot(line_stats, aes(x = Nombre_Trajets)) +
  geom_histogram(binwidth = 2, fill = "#17252a", color = "white") +
  labs(
    title = "Distribution du nombre de trajets par ligne",
    x = "Nombre de trajets",
    y = "Nombre de lignes"
  ) +
  theme_minimal(base_size = 12)
```

### Boxplot du nombre de trajets par ligne

```{r}
ggplot(line_stats, aes(y = Nombre_Trajets)) +
  geom_boxplot(fill = "#3aafa9") +
  labs(
    title = "Boite a moustaches du nombre de trajets par ligne",
    y = "Nombre de trajets"
  ) +
  theme_minimal(base_size = 12)
```

### Top 10 des lignes par nombre de trajets

```{r}
ggplot(top_10_lines, aes(x = reorder(Nom_Ligne, Nombre_Trajets), y = Nombre_Trajets)) +
  geom_col(fill = "#ff6f61") +
  coord_flip() +
  labs(
    title = "Top 10 des lignes les plus frequentes",
    x = "Ligne",
    y = "Nombre de trajets"
  ) +
  theme_minimal(base_size = 12)
```

### Relation entre arrets et trajets

```{r}
ggplot(line_stats, aes(x = Nombre_Arrets, y = Nombre_Trajets)) +
  geom_point(color = "#2c3e50", alpha = 0.7) +
  geom_smooth(method = "lm", se = FALSE, color = "#e74c3c") +
  labs(
    title = "Relation entre nombre d'arrets et nombre de trajets",
    x = "Nombre d'arrets",
    y = "Nombre de trajets"
  ) +
  theme_minimal(base_size = 12)
```

## Etape 4: Interpretation et synthese

- L'offre comprend `r total_lignes` lignes et `r total_arrets` arrets.
- Le service debute a `r first_bus_time` et se termine vers `r last_bus_time`,
  pour une amplitude d'environ `r round(amplitude_hours, 1)` heures.
- Les 15 lignes les plus frequentes representent `r percent(top_15_share)`
  de l'ensemble des trajets.
- La mediane du nombre de trajets par ligne est de `r trajets_stats$median_trajets`
  avec un intervalle interquartile de `r trajets_stats$q1_trajets` a
  `r trajets_stats$q3_trajets`.
